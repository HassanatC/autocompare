{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Scraper</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>
<body>

{% block content %}
<form method="post">
    {% csrf_token %}
    {{ form.as_p }} 
    <button type="submit">Scrape Data</button>
</form>

{% if data %}
    <h2 class="center-text">Given Car Data:</h2>
    <p class="center-text"><strong>Price:</strong>{{ data.price }}</p>
    <p class="center-text"><strong>Brand:</strong> {{ data.brand }}</p>
    <p class="center-text"><strong>Mileage:</strong> {{ data.mileage }}</p>
    <p class="center-text"><strong>Registration:</strong> {{ data.registration }}</p>
{% else %}
    <p class="no-data center-text">No data has been scraped yet.</p>
{% endif %}

{% if motors_data %}
    <h2 class="center-text">Similar Deals on Motors:</h2>

    <!-- Added mileage filter input and button -->
    <div class="filter-section">
        <label for="mileageFilter">Filter by Max Mileage (as kmiles):</label>
        <input type="number" id="mileageFilter" placeholder="Valid format is 56.9" />
        <button type="button" onclick="filterByMileage()">Apply Filter</button>
    </div>

    <ul id="motorsList">
        {% for motor in motors_data %}
            {% if motor.price != 'Error' %}
                <li>
                    <p class="center-text"><strong>Price:</strong> Â£{{ motor.price }}</p>
                    <!-- Added span for mileage value -->
                    <p class="center-text"><strong>Mileage:</strong> <span class="mileage-value">{{ motor.mileage }}</span> </p>
                    <p class="center-text"><strong>Link:</strong>
                        {% if motor.link != 'Error' %}
                            <a class="center-text" href="{{ motor.link }}" target="_blank">View Deal</a>
                        {% else %}
                            To be added as a later update
                        {% endif %}
                    </p>
                </li>
            {% endif %}
        {% endfor %}
    </ul>
{% else %}
    <p class="no-data center-text">No similar deals found on Motors.</p>
{% endif %}

{% endblock %}

<script>
    function filterByMileage() {
    const maxMileage = parseFloat(document.getElementById('mileageFilter').value) * 1000; // Convert input to miles
    if (isNaN(maxMileage)) {
        alert("Please enter a valid mileage.");
        return;
    }

    const listings = document.querySelectorAll('#motorsList li');
    listings.forEach(listing => {
        let mileageStr = listing.querySelector('.mileage-value').innerText;
        mileageStr = mileageStr.replace('kmiles', '').trim(); // Remove "kmiles" from the string
        const mileage = parseFloat(mileageStr) * 1000; // Convert the 'k' to its numerical value
        if (mileage > maxMileage) {
            listing.style.display = 'none';
        } else {
            listing.style.display = 'block';
        }
    });
}
</script>

</body>
</html>
